workflows:
  ios-native-quick-start:
    name: iOS Native
    max_build_duration: 120
    instance_type: mac_mini_m2
    integrations:
      app_store_connect: "MysteryInCasablancaAPI"  # <-- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!

    environment:
      groups:
        - MysteryInCasablancaAPI  # <-- –ò—Å–ø–æ–ª—å–∑—É–µ–º Variable Group —Å API-–∫–ª—é—á–∞–º–∏

      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.mystery-in-casablanca.ios

      vars:
        BUNDLE_ID: "com.mystery-in-casablanca.ios"
        XCODE_WORKSPACE: "mystery-in-casablanca.xcodeproj"
        XCODE_SCHEME: "mystery-in-casablanca"
        APP_STORE_APPLE_ID: 6742231210

      xcode: latest

    scripts:
      - name: –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Swift Package Manager
        script: |
          rm -rf ~/Library/Caches/org.swift.swiftpm
          rm -rf ~/Library/Developer/Xcode/DerivedData
          xcodebuild -resolvePackageDependencies

      - name: Set up provisioning profiles settings on Xcode project
        script: xcode-project use-profiles

      - name: Build ipa for distribution
        script: | 
          xcode-project build-ipa \
            --project "mystery-in-casablanca.xcodeproj" \
            --scheme "mystery-in-casablanca"

      - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π
        script: |
          echo "==> –ü—Ä–æ–≤–µ—Ä—è–µ–º API-–∫–ª—é—á–∏ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏:"
          echo "APP_STORE_API_KEY: ${APP_STORE_API_KEY:0:10}******"
          echo "APP_STORE_KEY_ID: ${APP_STORE_KEY_ID}"
          echo "APP_STORE_ISSUER_ID: ${APP_STORE_ISSUER_ID}"

          if [ -z "$APP_STORE_API_KEY" ] || [ -z "$APP_STORE_KEY_ID" ] || [ -z "$APP_STORE_ISSUER_ID" ]; then
            echo "üö® –û—à–∏–±–∫–∞: –û–¥–Ω–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö API –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Codemagic."
            exit 1
          else
            echo "‚úÖ API-–∫–ª—é—á–∏ –Ω–∞–π–¥–µ–Ω—ã!"
          fi

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM

    publishing:
      email:
        recipients:
          - m.shtupun@upstars.com
        notify:
          success: true
          failure: false
          
      app_store_connect:
        api_key: $APP_STORE_API_KEY
        key_id: $APP_STORE_KEY_ID
        issuer_id: $APP_STORE_ISSUER_ID
        submit_to_testflight: true
        submit_to_app_store: false
